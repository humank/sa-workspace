# ADR-002: MyAwesomeAirline 混合雲架構安全性評估 (第一部分)

## 狀態

提議中

## 決策日期

2025-03-27

## 背景與問題陳述

本ADR專注於MyAwesomeAirline混合雲架構的安全性評估，搭配先前的成本分析，作為架構決策的重要依據。

### 業務需求背景

MyAwesomeAirline正在規劃混合雲轉型，將訂位系統和行李追蹤系統遷移至AWS雲端，同時保留客戶管理系統在本地資料中心(IDC)。在確保成本效益的同時，架構必須符合航空業務的高安全性要求和數據保護標準。

### 現有環境

本地IDC網段使用172.168.0.0/16，目前安全性主要依賴傳統網絡安全模型，包括防火牆、IDS/IPS系統和傳統訪問控制。隨著混合雲架構的引入，需要重新評估安全架構，確保跨環境的一致安全控制。

### 解決方案目標

1. 建立安全的混合雲網絡架構，確保地端與雲端安全互通
2. 實施符合航空業規範的數據安全控制
3. 確保容器化工作負載的安全性與隔離性
4. 建立全面的安全監控和事件響應機制
5. 確保合規性並降低安全風險

## AWS混合雲架構安全性評估

### 網絡安全架構

#### 網絡分段與連接性設計

| 網段 | CIDR範圍 | 連接性策略 | 安全控制 | AWS最佳實踐遵循 |
|------|---------|------------|--------|-------------|
| 本地IDC網段 | 172.168.0.0/16 | 通過Direct Connect/VPN訪問雲端資源 | 區域防火牆、IDS/IPS系統 | ✓ 使用安全的專用網絡連接 |
| AWS VPC | 10.0.0.0/16 | 通過Transit Gateway連接各子網 | VPC流日誌、網絡ACL、安全組 | ✓ 符合AWS建議的VPC設計 |
| 公有子網 | 10.0.0.0/24, 10.0.1.0/24 | 允許來自全球IP的訪問 | WAF、Shield、安全組 | ✓ 只暴露必要的服務至公網 |
| 私有子網 | 10.0.2.0/24, 10.0.3.0/24 | 只允許從TGW和公有子網的訪問 | 嚴格安全組策略、網絡ACL | ✓ 敏感資源放置在私有子網 |

#### Direct Connect與Transit Gateway設計評估

Direct Connect連接採用雙線路設計，每條連接使用不同的物理路徑到達AWS，提供高可用性連接。針對用戶要求的網絡設計，進行以下評估：

1. **Private VIF評估**：
   - **建議使用Private VIF** - 由於需要連接本地IDC (172.168.0.0/16)與AWS VPC (10.0.0.0/16)，應使用Private VIF而非Public VIF
   - **實施理由**: Private VIF提供更安全的連接，不會暴露流量到公網，適合企業內部資源互通
   - **配置建議**: 設置BGP路由宣告，只允許必要的網段互通，實施路由過濾政策

2. **Transit Gateway部署評估**:
   - **建議使用TGW作為中心樞紐** - Transit Gateway將作為所有本地IDC與VPC連接的中心點
   - **路由表策略**: 為不同流量類型實施獨立的路由表，確保訪問控制精細性
   - **安全考量**: 在Transit Gateway上實施檢查點，監控所有跨邊界流量

3. **網絡連接冗餘性評估**:
   - **主連接**: 雙線路Direct Connect
   - **備援連接**: 雙線路Site-to-Site VPN
   - **故障轉移機制**: 實施BGP路由策略，確保自動故障轉移
   - **測試計劃**: 每季進行一次連接故障轉移測試

#### 網絡安全最佳實踐

| 安全領域 | 建議實施方案 | AWS服務 | 優先級 |
|---------|------------|--------|--------|
| 網絡流量監控 | 啟用VPC Flow Logs，整合集中式日誌分析 | CloudWatch Logs, Athena | 高 |
| 網絡入侵檢測 | 部署網絡IDS/IPS系統監控跨邊界流量 | AWS Network Firewall, 第三方IDS | 高 |
| DDoS防護 | 為公網服務部署DDoS防護 | AWS Shield, CloudFront | 高 |
| 網絡隔離 | 按功能進行VPC/子網隔離，實施安全組和網絡ACL | VPC, Security Groups, NACLs | 中 |
| 傳輸加密 | 所有跨網絡流量強制加密 | TLS, VPN, Direct Connect | 高 |

#### 子網訪問策略詳細設計

1. **公有子網設計**:
   - **入站規則**: 僅允許來自全球IP向Web服務(80/443)的訪問，以及運維IP的SSH訪問
   - **出站規則**: 限制只能訪問特定服務(如更新服務)的公網IP和私有子網
   - **安全組策略**: 為每種服務類型(Web、管理等)定義獨立安全組
   - **網絡ACL**: 作為安全組的補充，阻擋已知惡意IP和異常流量模式

2. **私有子網設計**:
   - **入站規則**: 只允許來自Transit Gateway(地端流量)和公有子網安全組的訪問
   - **出站規則**: 僅允許回程流量、DNS查詢和特定服務所需的內部通信
   - **安全組策略**: 為EKS Pod、數據庫等定義精細安全組
   - **分層防護**: 實施多層安全控制，確保即使一層被突破也能維持整體安全

3. **流量控制最佳實踐**:
   - 實施按最小特權原則設計的網絡流量策略
   - 禁止使用廣泛的CIDR範圍作為源或目標
   - 記錄和監控所有跨子網/VPC邊界流量
   - 定期審查和優化訪問控制列表

### Kubernetes (EKS) 安全配置

#### Pod安全與隔離策略

| 安全要素 | 配置建議 | 實施方法 | 效益評估 |
|---------|--------|----------|---------|
| Pod安全組 | 為EKS Pod配置安全組 | 使用Amazon VPC CNI插件的安全組功能 | 細粒度控制Pod級網絡訪問 |
| 命名空間隔離 | 按應用系統進行命名空間隔離 | 創建專用命名空間: `booking-system`和`baggage-tracking` | 實現應用間的資源與權限隔離 |
| 網絡策略 | 為每個命名空間定義網絡策略 | 使用Calico或AWS網絡策略控制器 | Pod間通信的精細控制 |
| 服務賬戶權限 | 每個應用使用最小權限服務賬戶 | 使用IAM Roles for Service Accounts (IRSA) | 將Pod權限限制在必要範圍內 |

#### Kubernetes安全最佳實踐實施評估

1. **控制平面安全**:
   - 實施私有API端點，禁止公網訪問
   - 啟用EKS控制平面日誌，集成至CloudWatch
   - 使用AWS KMS加密etcd存儲
   - 實現定期安全補丁自動更新

2. **容器安全**:
   - 實施ECR映像掃描，識別已知漏洞
   - 配置Pod安全策略，防止權限提升
   - 使用只讀文件系統，防止容器文件系統修改
   - 為容器資源設置硬限制，預防DoS攻擊

3. **機密管理**:
   - 使用AWS Secrets Manager存儲敏感憑證
   - 配置External Secrets Operator集成雲端機密
   - 避免在容器映像或配置文件中嵌入敏感信息
   - 實施定期密鑰輪換機制

### 命名空間設計與隔離建議

按照用戶要求，Pod的命名空間應按應用系統進行區隔，建議如下：

1. **命名空間結構**:
   - `booking-system`: 訂位系統相關的所有Pod
   - `baggage-tracking`: 行李追蹤系統相關的所有Pod
   - `shared-services`: 共享服務(如監控、日誌等)
   - `kube-system`: 系統組件(保持不變)

2. **命名空間隔離控制**:
   - 使用ResourceQuotas限制每個命名空間的資源使用
   - 使用NetworkPolicies限制跨命名空間通信
   - 使用RBAC限制對不同命名空間的訪問權限
   - 每個命名空間使用專用服務賬戶，遵循最小權限原則

3. **命名空間安全最佳實踐**:
   - 實施命名空間標籤策略，便於審計和政策執行
   - 為生產環境和非生產環境使用不同的命名空間
   - 定期審查命名空間權限和資源使用情況
   - 為關鍵命名空間實施更嚴格的Pod安全策略
